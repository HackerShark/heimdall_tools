require 'json'
require 'nokogiri'
require 'nori'
require 'heimdall_tools/hdf'

NIST_REFERENCE_NAME = 'Standards Mapping - NIST Special Publication 800-53 Revision 4'.freeze

module HeimdallTools
  class FortifyMapper
    def initialize(fvdl, verbose = false)
      @fvdl = fvdl
      @verbose = verbose

      begin
        data = Nori.new(empty_tag_value: true).parse(fvdl)
        @timestamp = data['FVDL']['CreatedTS']
        @vulns = data['FVDL']['Vulnerabilities']['Vulnerability']
        @snippets = data['FVDL']['Snippets']['Snippet']
        @rules = data['FVDL']['Description']
        @uuid = data['FVDL']['UUID']
        @fortify_version = data['FVDL']['EngineData']['EngineVersion']

      rescue StandardError => e
        raise "Invalid Fortify FVDL file provided Exception: #{e}"
      end
    end

    def process_entry(entry)
      snippetid = entry['Node']['SourceLocation']['@snippet']
      finding = {}
      finding['status'] = 'failed'
      finding['code_desc'] = snippet(snippetid)
      finding['run_time'] = NA_TAG
      finding['start_time'] = [@timestamp['@date'], @timestamp['@time']].join(' ')
      finding
    end

    def primaries(classid)
      matched_vulns = @vulns.select { |x| x['ClassInfo']['ClassID'].eql?(classid) }
      findings = []
      matched_vulns.each do |vuln|
        traces = vuln['AnalysisInfo']['Unified']['Trace']
        traces = [traces] unless traces.is_a?(Array)
        traces.each do |trace|
          entries = trace['Primary']['Entry']
          entries = [entries] unless entries.is_a?(Array)
          entries = entries.reject { |x| x['Node'].nil? }
          entries.each do |entry|
            findings << process_entry(entry)
          end
        end
      end
      findings.uniq
    end

    def snippet(snippetid)
      snippet = @snippets.select { |x| x['@id'].eql?(snippetid) }.first
      "\nPath: #{snippet['File']}\n" \
      "StartLine: #{snippet['StartLine']}, " \
      "EndLine: #{snippet['EndLine']}\n" \
      "Code:\n#{snippet['Text'].strip}" \
    end

    def nist_tag(rule)
      references = rule['References']['Reference']
      references = [references] unless references.is_a?(Array)
      tag = references.detect { |x| x['Author'].eql?(NIST_REFERENCE_NAME) }
      tag.nil? ? 'unmapped' : tag['Title'].match(/[a-zA-Z][a-zA-Z]-\d{1,2}/)
    end

    def impact(classid)
      vuln = @vulns.detect { |x| x['ClassInfo']['ClassID'].eql?(classid) }
      vuln['ClassInfo']['DefaultSeverity'].to_f / 5
    end

    def to_hdf

      # results_json = {}
      # results_json['platform'] = {}
      # results_json['platform']['name'] = 'Heimdall Tools'
      # results_json['platform']['release'] = HeimdallTools::VERSION
      # results_json['version'] = HeimdallTools::VERSION

      # results_json['statistics'] = {}
      # results_json['statistics']['duration'] = NA_TAG

      # results_json['profiles'] = []

      # profile_block = {}
      # profile_block['name'] = 'Fortify Static Analyzer Scan'
      # profile_block['version'] = @fortify_version

      # profile_block['sha256'] = NA_TAG
      # profile_block['title'] = 'Fortify Static Analyzer Scan'
      # profile_block['maintainer'] = NA_TAG
      # profile_block['summary'] = "Fortify Static Analyzer Scan of UUID: #{@uuid}"
      # profile_block['license'] = NA_TAG
      # profile_block['copyright'] = NA_TAG
      # profile_block['copyright_email'] = NA_TAG
      # profile_block['supports'] = []
      # profile_block['attributes'] = []
      # profile_block['depends'] = []
      # profile_block['groups'] = []
      # profile_block['status'] = 'loaded'

      # profile_block['controls'] = []
      # @rules.each do |rule|
      #   @item = {}
      #   @item['id']           = rule['@classID']
      #   @item['desc']         = rule['Explanation']
      #   @item['title']        = rule['Abstract']
      #   @item['impact']       = impact(rule['@classID'])
      #   @item['code']         = NA_TAG
      #   @item['results']      = []
      #   @item['results']      = primaries(@item['id'])
      #   @item['tags']         = {}
      #   @item['tags']['nist'] = [nist_tag(rule).to_s, 'Rev_4']
      #   profile_block['controls'] << @item
      # end
      # results_json['profiles'] << profile_block

      controls = []
      @rules.each do |rule|
        @item = {}
        @item['id']           = rule['@classID']
        @item['desc']         = rule['Explanation']
        @item['title']        = rule['Abstract']
        @item['impact']       = impact(rule['@classID'])
        @item['code']         = NA_TAG
        @item['results']      = []
        @item['results']      = primaries(@item['id'])
        @item['tags']         = {}
        @item['tags']['nist'] = [nist_tag(rule).to_s, 'Rev_4']
        controls << @item
      end
      results = HeimdallDataFormat.new(profile_name: 'Fortify Static Analyzer Scan',
                                       version: @fortify_version,
                                       title: 'Fortify Static Analyzer Scan',
                                       summary: "Fortify Static Analyzer Scan of UUID: #{@uuid}",
                                       controls: controls)
      results.to_hdf
    end
  end
end
